{% extends "base.html" %}
{% block content %}
<div class="jumbotron mt-4 p-5 bg-light rounded">
    <h1 class="display-4">Welcome, {{ username }}! <i class="fas fa-hand-sparkles"></i></h1>
    <p class="lead">Discover personalized beauty product recommendations just for you.</p>
    <hr class="my-4">
    <a class="btn btn-primary btn-lg" href="/recommendations" role="button">
        <i class="fas fa-magic"></i> Get Recommendations
    </a>
</div>

<!-- Data Insights (Viz Integration) -->
{% if viz_images %}
<div class="row mt-5">
    {% for img in viz_images %}
    <div class="col-md-6 mb-4">
        <h4>
            {% if img == 'rating_histogram.png' %}
            <i class="fas fa-chart-bar"></i> Rating Distribution
            {% elif img == 'categories_pie.png' %}
            <i class="fas fa-chart-pie"></i> Top Categories
            {% else %}
            <i class="fas fa-chart-line"></i> Model Performance
            {% endif %}
        </h4>
        <img src="{{ url_for('static', filename=img) }}" alt="Viz Chart" class="img-fluid rounded shadow" style="max-height: 300px;">
        <p class="text-muted small mt-2">Big Data insights from Spark analysis.</p>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-warning mt-5 text-center">
    <i class="fas fa-chart-bar fa-2x mb-2"></i>
    <h4>Viz Charts Loading...</h4>
    <p>Run viz.py to generate analytics charts. Demo: 700k+ reviews visualized!</p>
    <a href="#" onclick="location.reload()" class="btn btn-primary">Refresh</a>
</div>
{% endif %}
<!-- Sample Users for Demo (Mới: List users clickable) -->
<div class="mt-5">
    <h3><i class="fas fa-users"></i> Demo: Chọn User để Xem Recommendations Cá Nhân Hóa</h3>
    <p class="text-muted">Chọn một user từ training data (từ 632k users) để xem gợi ý sản phẩm dựa trên lịch sử reviews.</p>
    <div class="row">
        {% for user in sample_users %}
        <div class="col-md-4 col-sm-6 mb-3">
            <div class="card h-100 text-center border-primary">
                <div class="card-body">
                    <h5 class="card-title">{{ user.username or user.user_id[:10] }}...</h5>
                    <p class="card-text text-muted">{{ user.user_id }}</p>
                    <a href="/user/{{ user.user_id }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-eye"></i> Xem Recs
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<!-- Quick Recommendations Teaser -->
<div class="mt-5">
    <h3><i class="fas fa-star"></i> Quick Picks for You</h3>
    <div id="recCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            {% for rec in quick_recs or [] %}  <!-- Từ backend: pass quick_recs=... -->
            <div class="carousel-item {% if loop.first %}active{% endif %}">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">{{ rec.product.title[:50] }}...</h5>
                        <p class="card-text">Score: {{ "%.2f"|format(rec.score) }}</p>
                        <a href="/product/{{ rec.asin }}" class="btn btn-outline-primary">View</a>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="carousel-item active">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Explore Beauty Products</h5>
                        <p class="card-text">Personalized based on your history!</p>
                        <a href="/recommendations" class="btn btn-primary">View All</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#recCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#recCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>
</div>

<!-- Recent Activity với Loading -->
{% if recent_reviews %}
<div class="mt-5">
    <h3><i class="fas fa-history"></i> Your Recent Activity <span class="spinner-border spinner-border-sm ms-2 text-primary" role="status" style="display: none;" id="loadingSpinner"></span></h3>
    <div class="list-group mt-3" id="recentList">
        {% for review in recent_reviews %}
        <a href="/product/{{ review.asin }}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">{{ review.title or review.asin }}</h5>
                <small>
                    {% for i in range(review.rating|int) %}
                    <i class="fas fa-star rating-stars"></i>
                    {% endfor %}
                </small>
            </div>
            <p class="mb-1">{{ review.text[:150] }}...</p>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- JS cho loading (optional) -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('loadingSpinner').style.display = 'inline-block';
        setTimeout(() => { document.getElementById('loadingSpinner').style.display = 'none'; }, 1500);
    });
</script>
{% endblock %}